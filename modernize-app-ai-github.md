@lab.Title

Login to your VM with the following credentials...

**Username: ++@lab.VirtualMachine(Win11-Pro-Base-VM).Username++**

**Password: +++@lab.VirtualMachine(Win11-Pro-Base-VM).Password+++** 

<br>

---

*Welcome to your lab environment. Write your lab content here.*
#Welcome 
##Log In to the Virtual Machine.

**Username**: +++@lab.VirtualMachine(BuildBaseVM).Username+++

**Password**: +++@lab.VirtualMachine(BuildBaseVM).Password+++

 to the Modernize apps and data with generative AI using GitHub and Azure Lab! In this lab, you will perform an assessment on three .NET applications, migrate two of the applications to Azure App Service, perform code scan using Azure Migrate application and code assessment for .NET, use GitHub Copilot chat for autocomplete-style suggestions and experiment with a few of the modernization features available in App Service. Please follow the steps below to get started on your journey.

## Explore the applications

1. Go to the Windows Search bar and search for Internet Information Services (IIS) Manager. Open the Internet Information Services Manager.
2. Expand the connection on the left and then expand *Sites*. You will see three applications:
    - devshop, .NET Framework v4.8 application running on Port 80
    - aoiapp, .NET Framework v4.8 application running on Port 8000
    - Default web site, simple HTML application running on Port 9000 using Windows Authentication 
!IMAGE[inetmgr.jpg](instructions275719/inetmgr.jpg)

These applications are intended to demonstrate three scenarios: 
1. An application that is ready to be migrated to Azure App Service with no modifications
2. An application that is ready to be migrated, but requires minor modifications to work properly on App Service
3. An application that is not ready to be migrated and requires major modifications to be migrated to App Service

Continue to the next step to begin assessing the three applications. 

## Assessment

During this part of the lab, you will run a PowerShell script that runs several baseline checks on the applications running in IIS. It will generate a json file that tells you about the migration status of each application. 

1. Open a new ```Windows PowerShell``` terminal in Admin mode by typing PowerShell into the Windows Search bar, right clicking on ```Windows PowerShell``` and selecting *"Run as Administrator"*. Select *Yes* when prompted.
2. Navigate to the C:\scripts folder by running `cd C:\scripts`
3. Run the application assessment script by running `.\Get-SiteReadiness.ps1 -OverwriteReadinessResults`
4. When prompted, type ```.``` and hit enter. You should be prompted three times. 
5. After the script has completed, open the *ReadinessResults.json* file located in the same folder that was generated by the scripts by running ```code ReadinessResults.json```. 
6. You will see assessment results for the three applications:
    - default web site will indicate that it cannot be migrated due to Windows Authentication.
    - aoiapp will indicate that it could be migrated, but generates a warning about the port.
    - devshop will indicate that it is fully ready to be migrated and generates no warnings or checks. 

Keep your PowerShell terminal open for the upcoming migration step.

## Prepare to scan code using Azure Migrate application and code assessment for .NET

In this step we will use Azure Migrate application and code assessment for .NET Visual Studio extension to scan code for devshop web app . This extension provides details about code changes that may be required before the web app is migrated to App Service. For this lab zure Migrate application and code assessment extension is pre-installed but you can download this extension from https://marketplace.visualstudio.com/items?itemName=ms-dotnettools.appcat

1. Open Visual Studio 2022 and navigate to C:\Users\Admin\source\repos\devShop\devShop . Open an existing solution (devShop.sln )
2. Click on "GitHub Copilot" on the top right and sign-in with provided GitHub username and password. This will activate GitHub Copilot chat for your Visual Studio.
3. Once the solution is loaded with 2 projects right click on the devshop project and click "Re-platform to Azure".
!IMAGE[appcat_welcome.jpg](instructions275719/appcat_welcome.jpg)
4. On this screen select "New Report"
5. For the purpose of this lab Select "Azure App Service (Windows)" as target service on Azure. Click "Next"
6. By default all projects within the solution are selected. Leave the selaction as-is and click "Next"
7. For purpose of this lab we will analyze source code and settings (you can also include binary dependencies and define custom settings if needed). On this screen leave the default selection as-is and click "Analyze"
8. Once complete you will be presented with a summary dashbaord.
!IMAGE[appcat_dashboard.jpg](instructions275719/appcat_dashboard.jpg)
9. Click "Aggregate issues" on the left menu and expand the issue "Identity.0002".It is reported that devshop has "Windows" authentication configured in the web.config file. Click on "Ask Copilot" on the top right. A new Copilot chat window opens with possible resolution(s) for this issue. (for the purpose of this lab we will not make code changes)
10. Similarly expand the issue "Security.0002".It is reported that aoiwebapp has "Connection Strings" defined in the web.config file. Click on "Ask Copilot" on the top right. A new Copilot chat window opens with possible resolution(s) for this issue. (for the purpose of this lab we will not make code changes)


## Prepare the application for migration

In this step of the lab, you will prepare the application for migration. You will run a PowerShell script that zips up the website for the migration process.

1. Run `.\Get-SitePackage.ps1 -ReadinessResultsFilePath ReadinessResultsdevshop.json -SiteName devshop -PackageResultsFileName "PackageResultsdevshop.json"`
2. Run `.\Get-SitePackage.ps1 -ReadinessResultsFilePath ReadinessResultsaoiapp.json -SiteName aoiapp -PackageResultsFileName "PackageResultsaoiapp.json"`
3. Prepare the migration settings for the migration script by running `.\Generate-MigrationSettings.ps1 -SitePackageResultsPath packagedsites\PackageResultsdevshop.json -Region eastus2 -SubscriptionId @lab.CloudSubscription.Id -ResourceGroup RG@lab.LabInstance.Id`
4. Prepare the migration settings for the migration script by running `.\Generate-MigrationSettings.ps1 -SitePackageResultsPath packagedsites\PackageResultsaoiapp.json -Region eastus2 -SubscriptionId @lab.CloudSubscription.Id -ResourceGroup RG@lab.LabInstance.Id`
5. After the script has finished, open the *MigrationSettings.json* file by running ```code MigrationSettings.json```. Modify the *AzureSiteName* to `devshop@lab.LabInstance.Id`. The name here has to be globally unique for DNS resolution. 
6. Save the file
7. After the script has finished, open the *MigrationSettings.json* file by running ```code MigrationSettings.json```. Modify the *AzureSiteName* to `aoiapp@lab.LabInstance.Id`. The name here has to be globally unique for DNS resolution. 
8. Save the file. 

## Migrate the application
In this step of the lab, you will migrate your IBuySpy application to Azure App Service using a PowerShell script. The script sizes the application, creates an app service plan and an app service inside of an existing resource group. 

1. Run `.\Invoke-SiteMigration.ps1 -MigrationSettingsFilePath "MigrationSettings.json"`

After the script completes, you can navigate to the Azure Portal to view your application.

Please navigate to +++https://portal.azure.com+++ by opening an Edge window. 

Username: +++@lab.CloudPortalCredential(User1).Username+++

Password: +++@lab.CloudPortalCredential(User1).Password+++

When you login, navigate to *Resource Groups*. You will see a resource group with an app service plan, an app service, an Azure Oen AI , and an Azure KeyVault. The app service is now hosting your web application, but it is not yet fully functional. When the application lived on the VM, it was connected to a SQL database hosted on the same VM. Now that your application is in Azure, it will need to connect to a remote database. Move on to the next section to modernize your application and its database connection. 

## Modernize your application with App Service Platform Features
### Update the Database 
As mentioned in the previous section, you have an Azure SQL database available in your resource group. It has been pre-populated with the appropriate tables and data necessary for the IBuySpy application. For your application to use this new database, you will add the connection string to the Azure SQL database to an Azure KeyVault as a secret and have the Azure App Service read from the KeyVault. 

1. Create a System Assigned Managed Identity through App Service by going to *Settings* then *Identity* inside your App Service in the Azure Portal. Turn the button for *Status* to On and hit Save. 
![krk7ujc8.jpg](krk7ujc8.jpg)
2. Navigate to your Azure KeyVault in the Portal. 
3. Go to *Access control (IAM)*, click *Add* then *Add role assignment*
4. Select the *KeyVault Secrets User* role. 
5. On the next screen, select *Managed identity* then select your App Service Managed Identity from the dropdown and hit *Select*
6. Click *Review + assign*. Now your App Service has access to read the secrets in your KeyVault. 

To create the secret with the database connection string, you will need to assign yourself the role of KeyVault Secrets Officer in the RBAC permissions of the KeyVault. 

1. Navigate to your Azure KeyVault in the Portal
   ![iib29vql.jpg](iib29vql.jpg)
2. Go to *Access control (IAM)*, click *Add* then *Add role assignment*. 
3. Select the *KeyVault Secrets Officer* role
4. On the next screen, search for your username,+++@lab.CloudPortalCredential(User1).Username+++.
5. Click *Review + assign*. Now you have access to manage the secrets in your KeyVault.
6. Grab the connection string from the SQL Database by going to your SQL database in the Portal then to *Settings* and then *Connection Strings*. Select the *ADO.NET (SQL authentication)* option and replace *{your_password}* with ``. 
7. Create a secret in the KeyVault with the value as the connection string. By going to your KeyVault then look for *Secrets* under *Objects*. 
8. Select *Generate/Import*. Make the secret name something you will remember or save the name somewhere for reference. You will need it in a minute. The secret value should be the connection string from the previous step. Hit *Create* once you've filled out the secret name and value. 
9. Go to the Configuration section in the app service. Add two app settings variables:
    1. In *Application settings*: `DataConnectionString` = `ConnectionStringPaas`
    2. In *Connection strings*: `ConnectionStringPaas` = `@Microsoft.KeyVault(SecretUri=https://<Your KeyVault name>.vault.azure.net/secrets/<Your Secret name>/)` OR `@Microsoft.KeyVault(VaultName=<Your KeyVault name>;SecretName=<Your Secret name>)` and choose *Azure SQL* in the dropdown 
    ![xao3mycs.jpg](xao3mycs.jpg)
    Hit *Save* and wait for the app to restart. 

Once the app has successfully restarted, navigate to the URL for your application and you should be able to see the fully functional app with products listed on the site. If you do not see your application, check your connection string again in your Azure KeyVault. 

### Automatic scaling
In local .NET applications hosted on IIS, you handle scaling through your Application Pools. Azure App Service offers both vertical scaling (upgrading your App Service Plan) and horizontal scaling (creating multiple instances of your app). For the purposes of this lab, we are going to focus on horizontal scaling. 

Automatic scaling allows you to be prepared for unexpected spikes in traffic to your site. Let's say your IBuySpy site has unexpected spikes in traffic due to the hectic schedules spies have in various time zones. Enable automatic scaling by following the steps below to to handle the traffic.

1. Go to your App Service in the Portal. Navigate to *Settings* then *Scale out (App service plan)*. 
![0ovs066k.jpg](0ovs066k.jpg)
2. Configure scaling with the following settings:
    - Scale out method: *Automatic*
    - Maximum burst: *3*
    - Always ready instances: *1*
    - Enforce scale out limit: On
    - Maximum scale limit: *3*
3. Hit *Save* at the top of the screen. You just setup automatic scaling!

### Monitoring
A huge benefit of hosting your site in Azure is the ability to monitor your application and track specific metrics. Azure App Service allows you to easily enable monitoring through the portal to connect your site to Application Insights. Application Insights logs metrics and application telemetry data with features such as Live Metrics, Usage and Smart detection. Follow the steps below to enable Application Insights

1. Navigate to *Settings* then to *Application Insights*. Click the *Turn on Application Insights* button
2. Check the radio button for *Select existing resource*. Select the resource with the name RG@lab.LabInstance.Id
3. Hit *Apply*. 

You've now enabled monitoring! Move onto the next step to check out the Live Metrics and other features of Application Insights in action. 

### Availability Test
Application Insights Availability tests allow you to continuously monitor the responsiveness of your application. Follow the steps below to setup a basic availability test for your migrated application hosted on Azure App Service.    

1. Navigate to your Application Insights instance in the Azure portal.
2. Go to *Investigate* then *Availability*.
3. Click on *Add Standard Test*
![lhp3aa7g.jpg](lhp3aa7g.jpg)
1. Paste your App Service Domain URL into the URL box
![8sj9q1g0.jpg](8sj9q1g0.jpg)
1. Click *Create*. 

You just made your first availability test!

### Health Check 
Azure App Service has a health check feature that helps increase your application's availability by rerouting requests away from unhealthy instances, and replacing instances if they remain unhealthy. Follow the below steps to configure a health check for your migrated application on App Service.

1. Navigate to your App Service instance in the Azure portal.
2. Go to the *Monitoring* section and then *Health check*
3. Check the *enable* box to configure the health check.  
4. Configure the health check as /.
![r1fa7gll.jpg](r1fa7gll.jpg) 
1. Click *Save* at the top. 

You just enabled a health check for your migrated application! 

### Configuring Azure Load Test
Azure Load Testing allows you to conduct load tests on your applications and apis with either a custom JMeter script or it will generate one for you. In this lab, we're going to have you simulate a scaling scenario with Azure Load Test to see how you App Service reacts with automatic scaling enabled.  

1. Go to the Azure Portal and retrieve your App Service URL. Navigate to your App Service and grab the value of the default domain in the *Essentials* window. Save this value somewhere because you will need it for the next steps.
2. Search for Azure Load Testing in the Azure Portal
3. Hit *Create* in the upper left corner
4. Use the following parameters for setting up the load test:
    - Resource Group: ```RG@lab.LabInstance.Id```
    - Region: eastus

For everything else, leave the defaults. Hit *Review*
5. Navigate to *Tests*
6. Click *Create* on the upper middle of the window and then *Create a quick test*
![oj5qlw71.jpg](oj5qlw71.jpg)
7. Configure the load test with the following parameters:
    - Test URL: # Your App Service URL
    - Number of virtual users: 500
    - Test duration: 120s
    - Ramp-up time: 0s
8. Hit *Run test*
9. Once the test has completed, head over to your Application Insights instance attached to your App Service. Navigate to the *Live Metrics*. Checkout the graph for instance count and you will see your app auto scaled to 3 instances to support the load. You can also check out the performance counters by running the following query:
`requests
| where timestamp > ago(30m) 
| summarize count() by cloud_RoleInstance, bin(timestamp, 1m)
| render timechart`
![8lt164b1.jpg](8lt164b1.jpg)

## Next Steps
Now that you know more about Azure App Service, here are a couple of projects you could use to leverage your skills and customer experience further.

### __Checklist for migrating web apps to Azure App Service__ 
[Checklist](https://techcommunity.microsoft.com/t5/apps-on-azure-blog/checklist-for-migrating-web-apps-to-app-service/ba-p/3810991)

#### __App Service Landing Zone Accelerator__
The [App Service Landing Zone Accelerator](https://aka.ms/EnterpriseScale-AppService) is a reference architecture developed internally by Microsoft that demonstrates multiple scenarios using App Service including multi-tenant and App Service Environments. The architecture follows the Well-Architected Framework guidance for reliability, security, cost optimization, operational excellence, and performance efficiency. Check it out [here](https://github.com/Azure/appservice-landing-zone-accelerator) to learn more.  

#### __Bulk App Service Assessment for Azure Virtual Machines__
The [App Service Migration Assistant](https://azure.microsoft.com/en-us/products/app-service/migration-tools/), the PowerShell scripts you have used in this lab for assessment and migration, have been extended to support assessing 10s to 100s of .NET applications at one time. PowerShell wrapper scripts take in a list of Azure Virtual Machines with IIS hosted applications running, run pre-assessment checks, run the App Service migration assessment script on each Virtual Machine in parallel and upload the assessment results to Azure Blob Storage. To learn more about leveraging this with your customers, check out the repo [here](https://github.com/Azure/App-Service-Migration-Assistant).


